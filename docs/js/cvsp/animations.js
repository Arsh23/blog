// Orignal code: https://github.com/Arsh23/cvsp/blob/master/animations.js
var all={};function init_pixel(a,b){var c=a.size-2*a.linewidth,e=`M${a.x+a.linewidth},${a.y+a.linewidth}l${c},0l0,${c}l${-c},0Z`,f=`M${a.x},${a.y}l${a.size},0l0,${a.size}l${-a.size},0Z`;all[a.canvas_id].pixels[b]={status:'waiting',data:a};var g=d3.select('#'+a.canvas_id+'-canvas').append('g').attr('class','pixel').attr('id','pixel'+b);g.append('clipPath').attr('id','rendercrop-'+a.canvas_id+b).append('path').attr('id','rendercroppath-'+a.canvas_id+b),g.append('clipPath').attr('id','bgimagecrop-'+a.canvas_id+b).append('path').attr('d',f),g.append('path').attr('id','bgrect').attr('d',f).style('opacity','render'==all[a.canvas_id].reset_level?0:0.7),g.append('svg:image').attr('id','bgimage').attr('x',a.x+a.offsetX).attr('y',a.y+a.offsetY).attr('width',a.imgsize).attr('height',a.imgsize).attr('xlink:href',a.imgpath).attr('clip-path','url(#bgimagecrop-'+a.canvas_id+b+')').style('opacity','render'==all[a.canvas_id].reset_level?0.7:0).style('filter','url(#bw-filter)'),g.append('svg:image').attr('x',a.x+a.offsetX).attr('y',a.y+a.offsetY).attr('width',a.imgsize).attr('height',a.imgsize).attr('xlink:href',a.imgpath).attr('clip-path','url(#rendercrop-'+a.canvas_id+b+')'),g.append('path').attr('id','loading-line').attr('d',e).attr('stroke-linejoin','round').attr('stroke-linecap','round').attr('stroke-dasharray',4*a.size+' '+4*a.size).attr('stroke-dashoffset',4*a.size).style('stroke-width',2*a.linewidth),g.selectAll('path').style('fill','none').style('stroke','#2d2d2d')}function load(a,b){var c=d3.transition().ease(d3.easeLinear).duration(b.delay1);a.select('#loading-line').style('opacity',1).transition(c).attr('stroke-dashoffset',0).on('end',function(){d3.select(this).style('opacity',0)}),a.select('#bgimage').transition(c).style('opacity',0.7),a.select('#bgrect').transition(c).style('opacity',0)}function render(a,b,c){var e,f,g,k=0,n=b.size/10;for(f=0;f<=b.size-n;f+=n)for(e=n;e<=b.size;e+=n){var g=`M${b.x},${b.y}l${b.size},0l0,${f}l${-(b.size-e)},0l0,${n}l${-e},0Z`;a.select('#rendercroppath-'+b.canvas_id+c).transition().ease(d3.easeLinear).duration(0).delay(k).attr('d',g),k+=b.delay2/100}}function reset(a,b,c){all[a].load_finished=0,all[a].render_finished=0;var e=d3.transition().ease(d3.easeLinear).duration(b).delay(c);d3.select('#'+a).selectAll('.pixel').each(function(f,g){all[a].pixels[g].status='ended';var k=d3.select(this);'render'==all[a].reset_level?k.select('#rendercroppath-'+a+g).transition(e).attr('d',''):'load'==all[a].reset_level&&(k.select('#loading-line').attr('stroke-dashoffset',4*all[a].pixels[g].data.size).style('opacity',0),k.select('#bgimage').transition(e).style('opacity',0),k.select('#bgrect').transition(e).style('opacity',0.7),k.select('#rendercroppath-'+a+g).transition(e).attr('d',''))})}function generate_data(a){for(var b=[],c=0;c<a.gridsize;c++)for(var e=0;e<a.gridsize;e++)b.push({x:a.init_x+(e*a.size+e*a.gap),y:a.init_y+(c*a.size+c*a.gap),offsetX:-(e*a.size),offsetY:-(c*a.size),linewidth:a.linewidth,delay1:a.d1?a.d1:Math.floor(Math.random()*5501)+1500,delay2:a.d2?a.d2:100*(Math.floor(Math.random()*8)+8),size:a.size,imgsize:1==a.gridsize?4*a.size:a.size*a.gridsize,canvas_id:a.canvas_id,gridsize:a.gridsize,imgpath:a.imgpath});return b}function init_canvas(a,b,c){var e=parseInt(d3.select('#'+a).style('width')),f=b.size*b.gridsize+b.gap*(b.gridsize-1);f>e-b.width_margin&&(b.size=(e-b.width_margin-b.gap*(b.gridsize-1))/b.gridsize,b.size-=b.size%10);var g=b.size*b.gridsize+b.gap*(b.gridsize-1)+b.height_margin;b.init_x=(e-(b.size*b.gridsize+b.gap*(b.gridsize-1)))/2,b.init_y=b.height_margin/2;var k=d3.select('#'+a).append('svg').attr('width',e).attr('height',g).attr('id',a+'-canvas');k.append('defs').append('filter').attr('id','bw-filter').append('feColorMatrix').attr('type','saturate').attr('values','0'),all[a]={pixels:{}},all[a].checklist=[],all[a].started=!1,all[a].reset_level=c,all[a].total=b.gridsize*b.gridsize,b.canvas_id=a;var n=generate_data(b);n.forEach(init_pixel)}function start(a,b,c,e,f,g,k,n){return function(){all[a].load_queue=b?d3.queue(b):d3.queue(),all[a].render_queue=c?d3.queue(c):d3.queue(),all[a].sync=e,all[a].load_finished=0,all[a].render_finished=0,all[a].do_load=f,all[a].do_render=g,all[a].reset_level=k,all[a].checklist=n;for(var o=0;o<all[a].total;o++)all[a].pixels[o].status=!f&&g?'start_render':'start_load'}}function check_pixel(a,b){var c=all[a].pixels[b].data,e=d3.select('#'+a).select('#pixel'+b);if('start_load'==all[a].pixels[b].status&&all[a].do_load&&(all[a].pixels[b].status=all[a].sync?'start_render':'loading',all[a].load_queue.defer(function(g){e.call(load,c),d3.timeout(function(){all[a].load_finished+=1,all[a].sync||(all[a].pixels[b].status='start_render'),g(null)},c.delay1)})),'start_render'==all[a].pixels[b].status&&all[a].do_render){var f=all[a].sync?all[a].load_queue:all[a].render_queue;all[a].pixels[b].status='rendering',f.defer(function(g){e.call(render,c,b),d3.timeout(function(){all[a].render_finished+=1,g(null)},c.delay2)})}}d3.timer(function(){Object.keys(all).map(function(b){Object.keys(all[b].pixels).map(function(e){check_pixel(b,e)});var c=0;all[b].checklist.forEach(function(e){all[e].do_load&&!all[e].do_render?all[e].load_finished==all[e].total&&(c+=1):all[e].render_finished==all[e].total&&(c+=1)}),c==all[b].checklist.length&&all[b].checklist.forEach(function(e){reset(e,150,2e3),d3.timeout(all[e].start,3e3)})})});var default_meta={gridsize:4,size:100,offset:'50%',gap:4,init_x:0,init_y:0,width_margin:30,height_margin:40,linewidth:3,imgpath:'../imgs/cvsp/testimage1.jpg'};function start_anim(a,b,c,e,f,g,k,n,o){init_canvas(a,b,n),all[a].start=start(a,c,e,f,g,k,n,o);new Waypoint({element:document.getElementById(a),handler:function(){all[a].started||(all[a].started=!0,all[a].start())},offset:b.offset})}var m=Object.assign({},default_meta);m.gridsize=1,m.height_margin=10,m.widht_margin=10,m.offset='80%',m.size=150,m.d1=4e3,m.d2=4e3,start_anim('single-pixel-load',m,1,1,!1,!0,!1,'load',['single-pixel-load']),start_anim('single-pixel-render',m,1,1,!1,!1,!0,'render',['single-pixel-render']),start_anim('sync-ideal',default_meta,1,1,!0,!0,!0,'load',['sync-ideal']),start_anim('parallel-ideal',default_meta,0,0,!1,!0,!0,'load',['parallel-ideal']),start_anim('coroutine-ideal',default_meta,0,1,!1,!0,!0,'load',['coroutine-ideal']);var m2=Object.assign({},default_meta);m2.linewidth=2,m2.gap=3,m2.width_margin=10,start_anim('all-ideal-left',m2,1,1,!0,!0,!0,'load',['all-ideal-left','all-ideal-middle','all-ideal-right']),start_anim('all-ideal-middle',m2,0,1,!1,!0,!0,'load',['all-ideal-left','all-ideal-middle','all-ideal-right']),start_anim('all-ideal-right',m2,0,0,!1,!0,!0,'load',['all-ideal-left','all-ideal-middle','all-ideal-right']),default_meta.imgpath='../imgs/cvsp/testimage2.jpg',start_anim('io-bound-left',default_meta,8,1,!1,!0,!1,'load',['io-bound-left','io-bound-right']),start_anim('io-bound-right',default_meta,8,1,!1,!0,!1,'load',['io-bound-left','io-bound-right']),start_anim('cpu-bound-left',default_meta,8,1,!1,!1,!0,'render',['cpu-bound-left','cpu-bound-right']),start_anim('cpu-bound-right',default_meta,8,8,!1,!1,!0,'render',['cpu-bound-left','cpu-bound-right']),start_anim('both-bound-left',default_meta,8,1,!1,!0,!0,'load',['both-bound-left','both-bound-right']),start_anim('both-bound-right',default_meta,8,8,!1,!0,!0,'load',['both-bound-left','both-bound-right']);
